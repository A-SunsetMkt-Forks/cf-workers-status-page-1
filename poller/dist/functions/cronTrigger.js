import e from"../../config.json";import{getCheckLocation as t,getKVMonitors as s,setKVMonitors as i}from"./helpers";export async function processCronTrigger(n){let o=await t(),c=new Date().toISOString().split("T")[0],r=Date.now(),a=await s();for(let t of(a||(a={}),e.monitors)){console.log(`Checking ${t.name} ...`);let s={method:t.method||"GET",redirect:t.followRedirect?"follow":"manual",headers:{"User-Agent":e.settings.user_agent||"cf-workers-status-poller"}};void 0===a[t.id]&&(a[t.id]={lastIncident:void 0,operational:!0,incidents:[],checks:{}});let i=Date.now(),n=await fetch(t.url,s),d=Math.round(Date.now()-i),l=n.status===(t.expectStatus||200),h=a[t.id].operational!==l;if(!e.settings.collectResponseTimes&&l||a[t.id].checks.hasOwnProperty(c)||(a[t.id].checks[c]={incidents:[],summery:{},res:[]},a[t.id].operational||a[t.id].checks[c].incidents.push(a[t.id].lastIncident)),a[t.id].operational=l,e.settings.collectResponseTimes&&l){a[t.id].checks[c].res.hasOwnProperty(o)||(a[t.id].checks[c].summery[o]={n:0,ms:0,a:0});let e=++a[t.id].checks[c].summery[o].n,s=a[t.id].checks[c].summery[o].ms+=d;a[t.id].checks[c].summery[o].a=Math.round(s/e),a[t.id].checks[c].res.push({t:r,loc:o,ms:d}),h&&(a[t.id][a[t.id].lastIncident].end=r)}if(!l&&h){a[t.id].incidents.push({start:r,status:n.status,statusText:n.statusText});let e=a[t.id].incidents.length-1;a[t.id].checks[c].incidents.push(e)}}return await i(a),new Response("OK")}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mdW5jdGlvbnMvY3JvblRyaWdnZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNvbmZpZyBmcm9tICcuLi8uLi9jb25maWcuanNvbidcblxuaW1wb3J0IHtcbiAgZ2V0Q2hlY2tMb2NhdGlvbixcbiAgZ2V0S1ZNb25pdG9ycyxcbiAgc2V0S1ZNb25pdG9ycyxcbn0gZnJvbSAnLi9oZWxwZXJzJ1xuXG5mdW5jdGlvbiBnZXREYXRlKCkge1xuICByZXR1cm4gbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NDcm9uVHJpZ2dlcihldmVudCkge1xuICAvLyBHZXQgV29ya2VyIFBvUCBhbmQgc2F2ZSBpdCB0byBtb25pdG9yc1N0YXRlTWV0YWRhdGFcbiAgY29uc3QgY2hlY2tMb2NhdGlvbiA9IGF3YWl0IGdldENoZWNrTG9jYXRpb24oKVxuICBjb25zdCBjaGVja0RheSA9IGdldERhdGUoKVxuICBjb25zdCBub3cgPSBEYXRlLm5vdygpXG5cbiAgLy8gR2V0IG1vbml0b3JzIHN0YXRlIGZyb20gS1ZcbiAgbGV0IG1vbml0b3JzU3RhdGUgPSBhd2FpdCBnZXRLVk1vbml0b3JzKClcbiAgLy8gQ3JlYXRlIGVtcHR5IHN0YXRlIG9iamVjdHMgaWYgbm90IGV4aXN0cyBpbiBLViBzdG9yYWdlIHlldFxuICBpZiAoIW1vbml0b3JzU3RhdGUpIHtcbiAgICBtb25pdG9yc1N0YXRlID0ge31cbiAgfVxuXG4gIGZvciAoY29uc3QgbW9uaXRvciBvZiBjb25maWcubW9uaXRvcnMpIHtcblxuICAgIGNvbnNvbGUubG9nKGBDaGVja2luZyAke21vbml0b3IubmFtZX0gLi4uYClcblxuICAgIC8vIEZldGNoIHRoZSBtb25pdG9ycyBVUkxcbiAgICBjb25zdCBpbml0ID0ge1xuICAgICAgbWV0aG9kOiBtb25pdG9yLm1ldGhvZCB8fCAnR0VUJyxcbiAgICAgIHJlZGlyZWN0OiBtb25pdG9yLmZvbGxvd1JlZGlyZWN0ID8gJ2ZvbGxvdycgOiAnbWFudWFsJyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ1VzZXItQWdlbnQnOiBjb25maWcuc2V0dGluZ3MudXNlcl9hZ2VudCB8fCAnY2Ytd29ya2Vycy1zdGF0dXMtcG9sbGVyJyxcbiAgICAgIH0sXG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIGRlZmF1bHQgbW9uaXRvciBzdGF0ZSBpZiBkb2VzIG5vdCBleGlzdCB5ZXRcbiAgICBpZiAodHlwZW9mIG1vbml0b3JzU3RhdGVbbW9uaXRvci5pZF0gPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBtb25pdG9yc1N0YXRlW21vbml0b3IuaWRdID0ge1xuICAgICAgICBsYXN0SW5jaWRlbnQ6IHVuZGVmaW5lZCxcbiAgICAgICAgb3BlcmF0aW9uYWw6IHRydWUsXG4gICAgICAgIGluY2lkZW50czogW10sXG4gICAgICAgIGNoZWNrczoge30sXG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gUGVyZm9ybSBhIGNoZWNrIGFuZCBtZWFzdXJlIHRpbWVcbiAgICBjb25zdCByZXF1ZXN0U3RhcnRUaW1lID0gRGF0ZS5ub3coKVxuICAgIGNvbnN0IGNoZWNrUmVzcG9uc2UgPSBhd2FpdCBmZXRjaChtb25pdG9yLnVybCwgaW5pdClcbiAgICBjb25zdCByZXF1ZXN0VGltZSA9IE1hdGgucm91bmQoRGF0ZS5ub3coKSAtIHJlcXVlc3RTdGFydFRpbWUpXG5cbiAgICAvLyBEZXRlcm1pbmUgd2hldGhlciBvcGVyYXRpb25hbCBhbmQgc3RhdHVzIGNoYW5nZWRcbiAgICBjb25zdCBtb25pdG9yT3BlcmF0aW9uYWwgPSBjaGVja1Jlc3BvbnNlLnN0YXR1cyA9PT0gKG1vbml0b3IuZXhwZWN0U3RhdHVzIHx8IDIwMClcbiAgICBjb25zdCBtb25pdG9yU3RhdHVzQ2hhbmdlZCA9IG1vbml0b3JzU3RhdGVbbW9uaXRvci5pZF0ub3BlcmF0aW9uYWwgIT09IG1vbml0b3JPcGVyYXRpb25hbFxuXG4gICAgLy8gbWFrZSBzdXJlIGNoZWNrRGF5IGV4aXN0cyBpbiBjaGVja3MgaW4gY2FzZXMgd2hlbiBuZWVkZWRcbiAgICBpZiAoXG4gICAgICAoY29uZmlnLnNldHRpbmdzLmNvbGxlY3RSZXNwb25zZVRpbWVzIHx8ICFtb25pdG9yT3BlcmF0aW9uYWwpICYmXG4gICAgICAhbW9uaXRvcnNTdGF0ZVttb25pdG9yLmlkXS5jaGVja3MuaGFzT3duUHJvcGVydHkoY2hlY2tEYXkpXG4gICAgKSB7XG4gICAgICBtb25pdG9yc1N0YXRlW21vbml0b3IuaWRdLmNoZWNrc1tjaGVja0RheV0gPSB7XG4gICAgICAgIGluY2lkZW50czogW10sXG4gICAgICAgIHN1bW1lcnk6IHt9LFxuICAgICAgICByZXM6IFtdLFxuICAgICAgfVxuICAgICAgaWYgKCFtb25pdG9yc1N0YXRlW21vbml0b3IuaWRdLm9wZXJhdGlvbmFsKSB7XG4gICAgICAgIG1vbml0b3JzU3RhdGVbbW9uaXRvci5pZF0uY2hlY2tzW2NoZWNrRGF5XS5pbmNpZGVudHMucHVzaChtb25pdG9yc1N0YXRlW21vbml0b3IuaWRdLmxhc3RJbmNpZGVudClcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBTYXZlIG1vbml0b3IncyBsYXN0IGNoZWNrIHJlc3BvbnNlIHN0YXR1c1xuICAgIG1vbml0b3JzU3RhdGVbbW9uaXRvci5pZF0ub3BlcmF0aW9uYWwgPSBtb25pdG9yT3BlcmF0aW9uYWw7XG5cbiAgICBpZiAoY29uZmlnLnNldHRpbmdzLmNvbGxlY3RSZXNwb25zZVRpbWVzICYmIG1vbml0b3JPcGVyYXRpb25hbCkge1xuICAgICAgLy8gbWFrZSBzdXJlIGxvY2F0aW9uIGV4aXN0cyBpbiBjdXJyZW50IGNoZWNrRGF5XG4gICAgICBpZiAoXG4gICAgICAgICFtb25pdG9yc1N0YXRlW21vbml0b3IuaWRdLmNoZWNrc1tjaGVja0RheV0ucmVzLmhhc093blByb3BlcnR5KFxuICAgICAgICAgIGNoZWNrTG9jYXRpb24sXG4gICAgICAgIClcbiAgICAgICkge1xuICAgICAgICBtb25pdG9yc1N0YXRlW21vbml0b3IuaWRdLmNoZWNrc1tjaGVja0RheV0uc3VtbWVyeVtcbiAgICAgICAgICBjaGVja0xvY2F0aW9uXG4gICAgICAgIF0gPSB7XG4gICAgICAgICAgbjogMCxcbiAgICAgICAgICBtczogMCxcbiAgICAgICAgICBhOiAwLFxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIGluY3JlbWVudCBudW1iZXIgb2YgY2hlY2tzIGFuZCBzdW0gb2YgbXNcbiAgICAgIGNvbnN0IG5vID0gKyttb25pdG9yc1N0YXRlW21vbml0b3IuaWRdLmNoZWNrc1tjaGVja0RheV0uc3VtbWVyeVtcbiAgICAgICAgY2hlY2tMb2NhdGlvblxuICAgICAgXS5uXG4gICAgICBjb25zdCBtcyA9IChtb25pdG9yc1N0YXRlW21vbml0b3IuaWRdLmNoZWNrc1tjaGVja0RheV0uc3VtbWVyeVtcbiAgICAgICAgY2hlY2tMb2NhdGlvblxuICAgICAgXS5tcyArPSByZXF1ZXN0VGltZSlcblxuICAgICAgLy8gc2F2ZSBuZXcgYXZlcmFnZSBtc1xuICAgICAgbW9uaXRvcnNTdGF0ZVttb25pdG9yLmlkXS5jaGVja3NbY2hlY2tEYXldLnN1bW1lcnlbXG4gICAgICAgIGNoZWNrTG9jYXRpb25cbiAgICAgIF0uYSA9IE1hdGgucm91bmQobXMgLyBubylcblxuICAgICAgbW9uaXRvcnNTdGF0ZVttb25pdG9yLmlkXS5jaGVja3NbY2hlY2tEYXldLnJlcy5wdXNoKHtcbiAgICAgICAgdDogbm93LFxuICAgICAgICBsb2M6IGNoZWNrTG9jYXRpb24sXG4gICAgICAgIG1zOiByZXF1ZXN0VGltZVxuICAgICAgfSlcblxuICAgICAgLy8gYmFjayBvbmxpbmVcbiAgICAgIGlmIChtb25pdG9yU3RhdHVzQ2hhbmdlZCkge1xuICAgICAgICBtb25pdG9yc1N0YXRlW21vbml0b3IuaWRdW21vbml0b3JzU3RhdGVbbW9uaXRvci5pZF0ubGFzdEluY2lkZW50XS5lbmQgPSBub3c7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gZ28gZGFya1xuICAgIGlmICghbW9uaXRvck9wZXJhdGlvbmFsICYmIG1vbml0b3JTdGF0dXNDaGFuZ2VkKSB7XG4gICAgICBtb25pdG9yc1N0YXRlW21vbml0b3IuaWRdLmluY2lkZW50cy5wdXNoKHsgc3RhcnQ6IG5vdywgc3RhdHVzOiBjaGVja1Jlc3BvbnNlLnN0YXR1cywgc3RhdHVzVGV4dDogY2hlY2tSZXNwb25zZS5zdGF0dXNUZXh0IH0pXG4gICAgICBjb25zdCBpbmNpZGVudE51bWJlciA9IG1vbml0b3JzU3RhdGVbbW9uaXRvci5pZF0uaW5jaWRlbnRzLmxlbmd0aCAtIDFcbiAgICAgIG1vbml0b3JzU3RhdGVbbW9uaXRvci5pZF0uY2hlY2tzW2NoZWNrRGF5XS5pbmNpZGVudHMucHVzaChpbmNpZGVudE51bWJlcilcbiAgICB9XG4gIH1cblxuICAvLyBTYXZlIG1vbml0b3JzU3RhdGUgdG8gS1Ygc3RvcmFnZVxuICBhd2FpdCBzZXRLVk1vbml0b3JzKG1vbml0b3JzU3RhdGUpXG5cbiAgcmV0dXJuIG5ldyBSZXNwb25zZSgnT0snKVxufVxuIl0sIm5hbWVzIjpbImNvbmZpZyIsImdldENoZWNrTG9jYXRpb24iLCJnZXRLVk1vbml0b3JzIiwic2V0S1ZNb25pdG9ycyIsInByb2Nlc3NDcm9uVHJpZ2dlciIsImV2ZW50IiwiY2hlY2tMb2NhdGlvbiIsImNoZWNrRGF5IiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwic3BsaXQiLCJub3ciLCJtb25pdG9yc1N0YXRlIiwibW9uaXRvciIsIm1vbml0b3JzIiwiY29uc29sZSIsImxvZyIsIm5hbWUiLCJpbml0IiwibWV0aG9kIiwicmVkaXJlY3QiLCJmb2xsb3dSZWRpcmVjdCIsImhlYWRlcnMiLCJzZXR0aW5ncyIsInVzZXJfYWdlbnQiLCJpZCIsImxhc3RJbmNpZGVudCIsInVuZGVmaW5lZCIsIm9wZXJhdGlvbmFsIiwiaW5jaWRlbnRzIiwiY2hlY2tzIiwicmVxdWVzdFN0YXJ0VGltZSIsImNoZWNrUmVzcG9uc2UiLCJmZXRjaCIsInVybCIsInJlcXVlc3RUaW1lIiwiTWF0aCIsInJvdW5kIiwibW9uaXRvck9wZXJhdGlvbmFsIiwic3RhdHVzIiwiZXhwZWN0U3RhdHVzIiwibW9uaXRvclN0YXR1c0NoYW5nZWQiLCJjb2xsZWN0UmVzcG9uc2VUaW1lcyIsImhhc093blByb3BlcnR5Iiwic3VtbWVyeSIsInJlcyIsInB1c2giLCJuIiwibXMiLCJhIiwibm8iLCJ0IiwibG9jIiwiZW5kIiwic3RhcnQiLCJzdGF0dXNUZXh0IiwiaW5jaWRlbnROdW1iZXIiLCJsZW5ndGgiLCJSZXNwb25zZSJdLCJtYXBwaW5ncyI6IkFBQUEsT0FBT0EsTUFBWSxtQkFBbUIsQUFFdEMsUUFDRUMsb0JBQUFBLENBQWdCLENBQ2hCQyxpQkFBQUEsQ0FBYSxDQUNiQyxpQkFBQUEsQ0FBYSxLQUNSLFdBQVcsQUFNbEIsUUFBTyxlQUFlQyxtQkFBbUJDLENBQUssRUFFNUMsSUFBTUMsRUFBZ0IsTUFBTUwsSUFDdEJNLEVBTkMsSUFBSUMsT0FBT0MsV0FBVyxHQUFHQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FPdkNDLEVBQU1ILEtBQUtHLEdBQUcsR0FHaEJDLEVBQWdCLE1BQU1WLElBTTFCLElBQUssSUFBTVcsS0FKTkQsR0FDSEEsQ0FBQUEsRUFBZ0IsQ0FBQyxDQUFBLEVBR0daLEVBQU9jLFFBQVEsRUFBRSxDQUVyQ0MsUUFBUUMsR0FBRyxDQUFDLENBQUMsU0FBUyxFQUFFSCxFQUFRSSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBRzFDLElBQU1DLEVBQU8sQ0FDWEMsT0FBUU4sRUFBUU0sTUFBTSxFQUFJLE1BQzFCQyxTQUFVUCxFQUFRUSxjQUFjLENBQUcsU0FBVyxTQUM5Q0MsUUFBUyxDQUNQLGFBQWN0QixFQUFPdUIsUUFBUSxDQUFDQyxVQUFVLEVBQUksMEJBQzlDLENBQ0YsQ0FHeUMsTUFBQSxJQUE5QlosQ0FBYSxDQUFDQyxFQUFRWSxFQUFFLENBQUMsRUFDbENiLENBQUFBLENBQWEsQ0FBQ0MsRUFBUVksRUFBRSxD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